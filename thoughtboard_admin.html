<html>
<head>
<meta name=viewport content="width=device-width, initial-scale=1">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<script src="jquery.js"></script>
<script src="/twemoji/twemoji.min.js"></script>
<style>
table {
	border: 1px solid black;
	width:100%;
}
tr:nth-child(even) {
	background: lightblue;
}

.activeQ {
	background: lightgoldenrodyellow;
}

#plus {
	display:block;
    z-index: 1001;
    height: 2em;
    width: 2em;
    background-color: rgb(232, 48, 29);
    border-radius: 1em;
    position: fixed;
    bottom: 0px;
    right: 0px;
    text-align: center;
    margin: 1em;
    line-height: 1.875em;
    font-size: 2em;
    font-family:verdana;
    color: white;
    font-weight: bolder;
    text-shadow: -1px -1px 1px rgba(169,169,169,0.5);
    box-shadow: 2px 2px 20px rgba(0,0,0,.75);
}
#dialog {
	position:fixed;
	z-index:1001;
	display:block;
	height:25%;
	width:75%;
	top:10%;
	margin-left:auto;
	margin-right:auto;
	left:-100%;
	transform:translateX(-50%);
	padding:1em;
	animation-duration:1s;
	animation-timing-function:ease-out;
	animation-fill-mode: forwards;
	background: rgba(255,255,255,.95);
    box-shadow: 0px 0px 10px 2px rgba(255,255,255,.95);
}

@keyframes showDialog {
	from{left:-100%}
	to{left:50%}
}

@keyframes hideDialog {
	from{left:50%}
	to{left:-100%}
}
</style>
</head>
<body>
	<h1>Admin</h1>
	<div id="qaTable"></div>
	<span id="plus" onclick="showDialog()">+</span>
	<div id="dialog"><form id="subform" enctype='multipart/form-data'><textarea name="question"></textarea><br><input type="file" name="image"><span class="btnrow"><input type="submit" class="button blue" style="float:right;"><button id="cancel" style="float:right;margin-right:1em;" onclick='hideDialog()' class="button red">Cancel</button></span></form></div>
<script>
	$("#subform").submit(function(e){
		e.preventDefault();
		addQuestion(this);
		hideDialog();
	});
	$(document).ready(function(){
		getData(function(data){dispData(data)});
	});
	function getData(callback) {
		$.ajax({
			dataType:"json",
			url:"/admin/data",
			success: function(data){callback(data)}
			});
	}
	function dispData(data)
	{
		$("#qaTable").empty();
		for(x in data)
		{
			var table = document.createElement("table")
			var headRow = "<tr><th><button onclick='exportCSV(&quot;" + data[x]._id + "&quot;)'>Export Results (.csv)</button><br>"
			if(data[x].active && data[x].active === "true")
			{
				table.className = "activeQ"
				headRow += "<em style='color:red;font-weight:bold;'>Active Question</em></th><th>"
			}
			else
			{
				headRow += "<button onclick='activate(&quot;" + data[x]._id + "&quot;)'>Activate Question</button><br><button onclick='delQ(&quot;" + data[x]._id + "&quot;)'>Delete Question</button></th><th>"
			}
			headRow += data[x].question + "<br>"
			if(data[x].image)
			{
				headRow += "<img src='" + data[x].image.path + "'>"
			}
			headRow += "</th><th>" + new Date(data[x].date) + "</th></tr>"
			$(table).append(headRow)
			$(table).append("<tr><th></th><th>Answers</th><th>Timestamp</td></tr>")
			for(a in data[x].thoughts)
			{
				$(table).append("<tr><td><button onclick='edit(&quot;" + data[x].thoughts[a]._id + "&quot;)'>Edit</button><button onclick='del(&quot;" + data[x].thoughts[a]._id + "&quot;)'>Delete</button></td><td id=" + data[x].thoughts[a]._id + ">" + data[x].thoughts[a].message + "</td><td>" + new Date(data[x].thoughts[a].timeStamp) + "</td></tr>")
			}
			$("#qaTable").prepend(table)
		}
	}
	function edit(aID)
	{
		var msg = prompt("Enter edited answer", document.getElementById(aID).innerHTML)
		$.ajax({
			url:"/admin/answer/edit?id=" + aID + "&message=" + msg,
			success:function(){
					getData(function(data){
						dispData(data)
					});	
				}
			})
	}
	function del(aID)
	{
		var conf = confirm("Are you sure you want to delete this answer?")
		if(conf == true)
		{
		$.ajax({
			url:"/admin/answer/delete?id=" + aID,
			success:function(){
					getData(function(data){
						dispData(data)
					});	
				}
			})
		}
	}
	function delQ(qID)
	{
		var conf = confirm("Are you sure you want to delete this question and all answers?")
		if(conf == true)
		{
		$.ajax({
			url:"/admin/question/delete?id=" + qID,
			success:function(d){
					console.log(d)
					getData(function(data){
						dispData(data)
					});	
				}
			})
		}
	}
	function exportCSV(qID){
		window.open("/admin/question/export.csv?id=" + qID,"_blank")
		/*
		$.ajax({
			url:"/admin/question/export?id=" + qID,
			success:function(d){
					console.log(d)
				}
			})
		*/
	}
	function showDialog(){
		document.getElementById("dialog").style.animationName = "showDialog";
	}
	function hideDialog() {
		document.getElementById("dialog").style.animationName = "hideDialog";
	}
	function addQuestion(fdata)
	{
		//var q = prompt("Enter a new Question")
		var data = new FormData(fdata);
		console.log(data)
		$.ajax({
			type:"POST",
			url:"/admin/question/add",
			contentType:false,
			processData:false,
			data: data,
			success:function(){
					getData(function(data){
						dispData(data)
					});	
				}
			})
	}
	function activate(id)
	{
		$.ajax({
			url:"/admin/question/activate?id=" + id,
			success:function(){
					getData(function(data){
						dispData(data)
					});	
				}
			})
	}
</script>
</body>
</html>
